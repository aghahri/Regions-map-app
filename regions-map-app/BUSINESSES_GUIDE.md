# راهنمای استفاده از قابلیت نمایش کسب و کارهای محلی

## خلاصه

این قابلیت امکان نمایش کسب و کارهای محلی را روی نقشه فراهم می‌کند. داده‌ها می‌توانند از فایل RAR (حاوی Excel) یا مستقیماً از فایل Excel آپلود شوند.

## مراحل استفاده

### 1. آماده‌سازی فایل

فایل شما باید یکی از این فرمت‌ها باشد:
- **RAR** (حاوی فایل Excel)
- **Excel** (`.xlsx` یا `.xls`)

### 2. ساختار فایل Excel

فایل Excel باید دارای ستون‌های زیر باشد:

#### ستون‌های الزامی:
- **عرض جغرافیایی (Latitude)**: می‌تواند با نام‌های `lat`, `latitude`, `عرض`, `y` باشد
- **طول جغرافیایی (Longitude)**: می‌تواند با نام‌های `lon`, `lng`, `longitude`, `طول`, `x` باشد

#### ستون‌های اختیاری:
- **نام کسب و کار**: می‌تواند با نام‌های `name`, `نام`, `title`, `عنوان` باشد
- سایر ستون‌ها: تمام ستون‌های دیگر به عنوان اطلاعات اضافی در popup نمایش داده می‌شوند

### 3. آپلود فایل

1. وارد پنل ادمین شوید: `/admin/login`
2. به صفحه آپلود کسب و کارها بروید: `/admin/businesses/upload`
3. نام شهر را وارد کنید (مثلاً: `tabriz`)
4. فایل را انتخاب کنید
5. روی دکمه "آپلود و پردازش" کلیک کنید

### 4. استفاده از اسکریپت پردازش (اختیاری)

اگر می‌خواهید فایل را به صورت دستی پردازش کنید:

```bash
cd /var/www/regions-map-app/regions-map-app
python3 process_businesses.py "/path/to/file.rar"
```

این اسکریپت:
- فایل RAR را استخراج می‌کند
- فایل Excel را می‌خواند
- داده‌ها را به GeoJSON تبدیل می‌کند
- فایل را در `uploads/uploads/regions/businesses/` ذخیره می‌کند

### 5. نمایش در نقشه

برای نمایش کسب و کارها در نقشه، یکی از این روش‌ها را استفاده کنید:

#### روش 1: استفاده از Query Parameter
```
/map/{map_id}?city=tabriz
```

#### روش 2: استفاده از JavaScript
کد JavaScript به صورت خودکار کسب و کارها را بارگذاری می‌کند اگر:
- Query parameter `city` موجود باشد
- یا متغیر `cityName` در template تنظیم شده باشد

## API Endpoints

### دریافت GeoJSON کسب و کارها
```
GET /api/businesses/{city_name}
```

مثال:
```
GET /api/businesses/tabriz
```

پاسخ:
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [46.2833, 38.0833]
      },
      "properties": {
        "name": "نام کسب و کار",
        "address": "آدرس",
        ...
      }
    }
  ]
}
```

## ساختار فایل‌ها

فایل‌های GeoJSON در مسیر زیر ذخیره می‌شوند:
```
uploads/uploads/regions/businesses/{city_name}_businesses.json
```

مثال:
```
uploads/uploads/regions/businesses/tabriz_businesses.json
```

## نمایش در نقشه

کسب و کارها به صورت **markerهای نارنجی** روی نقشه نمایش داده می‌شوند:
- رنگ: نارنجی (`#ff7800`)
- اندازه: 6 پیکسل
- با کلیک روی هر marker، popup با اطلاعات کسب و کار نمایش داده می‌شود

## مثال کامل

### 1. آپلود فایل تبریز

```
1. ورود به /admin/businesses/upload
2. نام شهر: tabriz
3. انتخاب فایل: تبریز (1).rar
4. کلیک روی "آپلود و پردازش"
```

### 2. مشاهده در نقشه

```
/map/{map_id}?city=tabriz
```

یا در کد JavaScript:
```javascript
loadBusinesses('tabriz');
```

## نکات مهم

1. **نام شهر**: باید به صورت انگلیسی و بدون فاصله باشد (مثلاً: `tabriz` نه `تبریز`)
2. **مختصات**: باید در سیستم WGS84 (EPSG:4326) باشند
3. **فرمت فایل**: RAR یا Excel (`.xlsx`, `.xls`)
4. **اندازه فایل**: محدودیت 200MB (در تنظیمات Nginx)

## عیب‌یابی

### مشکل: فایل آپلود نمی‌شود
- بررسی کنید که فایل معتبر است
- بررسی کنید که ستون‌های مختصات وجود دارند
- لاگ‌های Flask را بررسی کنید

### مشکل: کسب و کارها نمایش داده نمی‌شوند
- بررسی کنید که فایل GeoJSON در مسیر درست ذخیره شده است
- بررسی کنید که نام شهر در URL درست است
- Console مرورگر را برای خطاهای JavaScript بررسی کنید

### مشکل: مختصات اشتباه است
- مطمئن شوید که ستون‌ها به درستی شناسایی شده‌اند
- بررسی کنید که مختصات در محدوده معتبر هستند (lat: -90 تا 90, lon: -180 تا 180)

## پشتیبانی

برای مشکلات بیشتر، لاگ‌های Flask را بررسی کنید:
```bash
sudo journalctl -u regions-map-app -f
```

